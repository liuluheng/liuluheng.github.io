<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Linux startup process</title>
<!-- 2015-03-05 Thu 23:20 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Shi Shougang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link href="../../assets/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="../../assets/bootstrap-responsive.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../assets/stylesheet.css" />
<script src="assets/js/bootstrap.min.js"></script>

<script type="text/javascript" src="assets/js/org-info.js">
/**
 *
 * @source: assets/js/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in assets/js/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in assets/js/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "2");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "0");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "#dddddd");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "showall");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Linux startup process</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">bootloader</a></li>
<li><a href="#sec-2"><code>head.S</code></a></li>
<li><a href="#sec-3"><code>start_kernel</code></a>
<ul>
<li><a href="#sec-3-1"><code>printk(linux_banner);</code></a></li>
<li><a href="#sec-3-2">架构有关的初始化 <code>setup_arch</code></a></li>
<li><a href="#sec-3-3">继续architecture-independent初始化</a></li>
<li><a href="#sec-3-4"><code>setup_per_cpu_areas();</code></a></li>
<li><a href="#sec-3-5"><code>smp_prepare_boot_cpu();</code></a></li>
<li><a href="#sec-3-6"><code>sched_init();</code></a></li>
<li><a href="#sec-3-7">Parsing command line options</a></li>
<li><a href="#sec-3-8"><code>sort_main_extable();</code></a></li>
<li><a href="#sec-3-9"><code>trap_init();</code></a></li>
<li><a href="#sec-3-10"><code>init_IRQ();</code></a></li>
<li><a href="#sec-3-11"><code>pidhash_init();</code></a></li>
<li><a href="#sec-3-12"><code>init_timers();</code></a></li>
<li><a href="#sec-3-13"><code>hrtimers_init();</code></a></li>
<li><a href="#sec-3-14"><code>softirq_init();</code></a></li>
<li><a href="#sec-3-15"><code>timekeeping_init();</code></a></li>
<li><a href="#sec-3-16"><code>time_init();</code></a></li>
<li><a href="#sec-3-17"><code>console_init();</code></a></li>
<li><a href="#sec-3-18"><code>lockdep_info();</code></a></li>
<li><a href="#sec-3-19"><code>mem_init();</code></a></li>
<li><a href="#sec-3-20"><code>kmem_cache_init();</code></a></li>
<li><a href="#sec-3-21"><code>calibrate_delay();</code></a></li>
<li><a href="#sec-3-22">some inits</a></li>
<li><a href="#sec-3-23"><code>fork_init(num_physpages);</code></a></li>
<li><a href="#sec-3-24"><code>proc_caches_init();</code></a></li>
<li><a href="#sec-3-25"><code>buffer_init(void)</code></a></li>
<li><a href="#sec-3-26"><code>vfs_caches_init(num_physpages);</code></a></li>
<li><a href="#sec-3-27"><code>signals_init();</code></a></li>
<li><a href="#sec-3-28"><code>proc_root_init();</code></a></li>
<li><a href="#sec-3-29"><code>check_bugs();</code></a></li>
<li><a href="#sec-3-30"><code>rest_init();</code></a></li>
</ul>
</li>
<li><a href="#sec-4"><code>rest_init</code></a>
<ul>
<li><a href="#sec-4-1">start init thread</a></li>
<li><a href="#sec-4-2">create kthreadd thread</a></li>
<li><a href="#sec-4-3"><code>unlock_kernel();</code></a></li>
<li><a href="#sec-4-4"><code>schedule();</code> and <code>cpu_idle();</code></a></li>
</ul>
</li>
<li><a href="#sec-5"><code>setup_arch(&amp;command_line)</code></a>
<ul>
<li><a href="#sec-5-1"><code>setup_processor</code></a></li>
<li><a href="#sec-5-2"><code>setup_machine</code></a></li>
<li><a href="#sec-5-3">Set memory limits</a></li>
<li><a href="#sec-5-4"><code>parse_cmdline(cmdline_p, from);</code></a></li>
<li><a href="#sec-5-5"><code>cpu_init();</code></a></li>
<li><a href="#sec-5-6">Set up various architecture-specific pointers</a></li>
</ul>
</li>
<li><a href="#sec-6"><code>kernel_init</code> thread</a></li>
<li><a href="#sec-7"><code>do_basic_setup</code></a>
<ul>
<li><a href="#sec-7-1"><code>do_initcalls</code></a></li>
</ul>
</li>
<li><a href="#sec-8">reference</a>
<ul>
<li><a href="#sec-8-1"><code>cpu_idle</code></a></li>
<li><a href="#sec-8-2"><code>setup_arch</code></a></li>
<li><a href="#sec-8-3"><code>kernel_init</code></a></li>
<li><a href="#sec-8-4"><code>init_post</code></a></li>
<li><a href="#sec-8-5"><code>do_basic_setup</code></a></li>
</ul>
</li>
<li><a href="#sec-9">cc</a></li>
</ul>
</div>
</div>
<p>
主要以Linux kernel 2.6.24的ARM架构的启动过程为例.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">bootloader</h2>
<div class="outline-text-2" id="text-1">
<p>
以Uboot为例, <code>bootm addr</code> , 从Linux kernel所在起始地址启动.
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><code>head.S</code></h2>
<div class="outline-text-2" id="text-2">
<p>
<code>/arch/arm/kernel/head.S</code> 为kernel的起始代码,对CPU和Memory做一下汇编级的初始化,最后  <code>`#include "head-common.S"`</code>
</p>

<p>
在同目录下的 <code>head-common.S</code> 最后调用跳转指令 <code>b start_kernel</code>,进入C语言级architecture-independent的初始化.
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><code>start_kernel</code></h2>
<div class="outline-text-2" id="text-3">
<p>
函数 <code>start_kernel()</code> 在 <code>linux/init/main.c</code> 中,它不会放回到它的调用者那,它最终调用死循环函数 <a href="#cpu_idle"><code>cpu_idle()</code></a> .
</p>

<p>
中断们 <code>local_irq_disable();</code> 仍然被关闭此时.做写必要的准备工作,然后打开它们.先
<code>lock_kernel();</code> .
</p>

<p>
若打开 <code>CONFIG_TRACE_IRQFLAGS</code> , <code>early_init_irq_lock_class();</code> 为一个全局中断描述符表格 <code>struct irq_desc irq_desc[NR_IRQS];</code> 中所有locks映射到单一的一个lock-class.
</p>

<p>
若打开 <code>CONFIG_HIGHMEM</code>, <code>page_address_init(void)</code> 初始化页地址,用链表把它们串起来.
</p>
</div>
<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><code>printk(linux_banner);</code></h3>
<div class="outline-text-3" id="text-3-1">
<p>
<code>printk(linux_banner);</code> 打印字符串 <code>linux_banner</code> (这字符串在
<code>linux/init/version.c</code> 中). <b>Note:</b> <code>printk()</code> 此时并没有实际把这字符串打印到终端,它只是缓存字符串直到终端设备把自己注册到内核.然后内核把缓存的终端log内容传递给注册的终端设备.同时可以存在多个注册的终端设备.
</p>

<p>
<code>printk()</code> can be called very early because it doesn't actually print to
anywhere. It just logs the message to "<code>log_buf</code>" , which is allocated
statically in "<code>linux/kernel/printk.c</code>". The messages that are saved in
"<code>log_buf</code>" are passed to registered console devices as they register.
</p>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">架构有关的初始化 <code>setup_arch</code></h3>
<div class="outline-text-3" id="text-3-2">
<p>
Call <a href="#setup_arch"><code>setup_arch(&amp;command_line);</code></a> :
</p>

<p>
This performs architecture-specific initializations (details below).
Then back to architecture-independent initialization
</p>

<p>
The remainder of <code>start_kernel()</code> is done as follows for all processor
architecures, although several of these function calls are to
architecture-specific setup/init functions.
</p>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">继续architecture-independent初始化</h3>
<div class="outline-text-3" id="text-3-3">
<p>
<code>setup_command_line(command_line);</code> 
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #ff7f24;">/*</span>
<span style="color: #ff7f24;"> * We need to store the untouched command line for future reference.</span>
<span style="color: #ff7f24;"> * We also need to store the touched command line since the parameter</span>
<span style="color: #ff7f24;"> * parsing is performed in place, and we should allow a component to</span>
<span style="color: #ff7f24;"> * store reference of name/value for future reference.</span>
<span style="color: #ff7f24;"> </span><span style="color: #ff7f24;">*/</span>
strcpy (saved_command_line, boot_command_line);
strcpy (static_command_line, command_line);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><code>setup_per_cpu_areas();</code></h3>
<div class="outline-text-3" id="text-3-4">
<p>
设置下SMP的每个CPU分配pre-cpu结构内存， 并将.data.percpu段的数据复制到其中.
</p>
</div>
</div>
<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><code>smp_prepare_boot_cpu();</code></h3>
<div class="outline-text-3" id="text-3-5">
<p>
SMP相关,ARM架构下只是简单设置了下idle进程:
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #98fb98;">void</span> <span style="color: #87cefa;">__init</span> smp_prepare_boot_cpu(<span style="color: #98fb98;">void</span>)
{
  <span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">cpu</span> = smp_processor_id();
  per_cpu(cpu_data, cpu).idle = current;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6"><code>sched_init();</code></h3>
<div class="outline-text-3" id="text-3-6">
<p>
<code>/kernel/sched.c</code> 
</p>

<ul class="org-ul">
<li>set the <code>struct task_struct init_task = INIT_TASK(init_task);</code>.
</li>
<li>init idle thread, <code>init_idle(current, smp_processor_id());</code>.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-7" class="outline-3">
<h3 id="sec-3-7">Parsing command line options</h3>
<div class="outline-text-3" id="text-3-7">
<p>
<code>parse_early_param();</code> parse "eary options", as <code>parse_args("early
options", tmp_cmdline, NULL, 0, do_early_param);</code>
</p>

<p>
<code>parse_args</code>: Parse the kernel options on the command line. This is
  a simple kernel command line parsing function. It parses the command
  line and fills in the arguments and environment to init (thread) as
  appropriate. Any command-line option is taken to be an environment
  variable if it contains the character '='. It also checks for
  options meant for the kernel by calling <code>unknown_bootoption</code>, and
  in it call <code>obsolete_checksetup()</code> ,hich checks the command line for
  kernel parameters, these being specified by declaring them using
  "<code>__setup</code>", as in:
</p>
<div class="org-src-container">

<pre class="src src-c">__setup(<span style="color: #ffa07a;">"debug"</span>, debug_kernel);
</pre>
</div>

<p>
This declaration causes the <code>debug_kernel()</code> function to be called when
the string "debug" is scanned. See
"linux/Documentation/kernel-parameters.txt" for the list of kernel
parameters.
</p>

<p>
These options are not given to init &#x2013; they are for internal kernel
use only. The default argument list for the init thread is <code>{"init",
NULL}</code>, with a maximum of 8 command-line arguments. The default
environment list for the init thread is <code>{"HOME=/", "TERM=linux",
NULL}</code>, with a maximum of 8 command-line environment variable
settings.
</p>
</div>
</div>
<div id="outline-container-sec-3-8" class="outline-3">
<h3 id="sec-3-8"><code>sort_main_extable();</code></h3>
<div class="outline-text-3" id="text-3-8">
<p>
Sort the kernel's built-in exception table.
</p>
</div>
</div>
<div id="outline-container-sec-3-9" class="outline-3">
<h3 id="sec-3-9"><code>trap_init();</code></h3>
<div class="outline-text-3" id="text-3-9">
<p>
in <code>/arch/arm/kernel/traps.c</code>.
对中断向量表进行初始化,如下:
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span> <span style="color: #eedd82;">vectors</span> = CONFIG_VECTORS_BASE;
memcpy((<span style="color: #98fb98;">void</span> *)vectors, __vectors_start, __vectors_end - __vectors_start);
memcpy((<span style="color: #98fb98;">void</span> *)vectors + 0x200, __stubs_start, __stubs_end - __stubs_start);
memcpy((<span style="color: #98fb98;">void</span> *)vectors + 0x1000 - kuser_sz, __kuser_helper_start, kuser_sz);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-10" class="outline-3">
<h3 id="sec-3-10"><code>init_IRQ();</code></h3>
<div class="outline-text-3" id="text-3-10">
<p>
<code>arch/arm/kernel/irq.c</code>
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #00ffff;">for</span> (irq = 0; irq &lt; NR_IRQS; irq++)
                irq_desc[irq].status |= IRQ_NOREQUEST | IRQ_NOPROBE;
</pre>
</div>
<p>
初始化了从中断向量表，不过，这时的中断响应程序由于中断控制器的引脚还未被占用，自然是空程序了。当我们确切地知道了一个引脚到底连接了什么设备，并知道了该设备的驱动程序后，填写该引脚对应的中断门时，中断响应程序的偏移地址才被填写进中断向量表。
</p>

<pre class="example">
// in =setup_arch()=
init_arch_irq = mdesc-&gt;init_irq;
init_arch_irq();
</pre>

<p>
Run architecture-specific initial irq.
</p>
</div>
</div>
<div id="outline-container-sec-3-11" class="outline-3">
<h3 id="sec-3-11"><code>pidhash_init();</code></h3>
<div class="outline-text-3" id="text-3-11">
<p>
The pid hash table is scaled according to the amount of memory in the
machine.
</p>
</div>
</div>
<div id="outline-container-sec-3-12" class="outline-3">
<h3 id="sec-3-12"><code>init_timers();</code></h3>
<div class="outline-text-3" id="text-3-12">
<p>
初始化定时器:
</p>
<div class="org-src-container">

<pre class="src src-c">open_softirq(TIMER_SOFTIRQ, run_timer_softirq, <span style="color: #7fffd4;">NULL</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-13" class="outline-3">
<h3 id="sec-3-13"><code>hrtimers_init();</code></h3>
<div class="outline-text-3" id="text-3-13">
<p>
初始化高精度时钟.
</p>
</div>
</div>
<div id="outline-container-sec-3-14" class="outline-3">
<h3 id="sec-3-14"><code>softirq_init();</code></h3>
<div class="outline-text-3" id="text-3-14">
<p>
<code>kernel/softirq.c</code>
打开两个softirq:
</p>
<div class="org-src-container">

<pre class="src src-c">open_softirq(TASKLET_SOFTIRQ, tasklet_action, <span style="color: #7fffd4;">NULL</span>);
open_softirq(HI_SOFTIRQ, tasklet_hi_action, <span style="color: #7fffd4;">NULL</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-15" class="outline-3">
<h3 id="sec-3-15"><code>timekeeping_init();</code></h3>
<div class="outline-text-3" id="text-3-15">
<p>
<code>kernel/time/timekeeping.c</code>
</p>

<p>
Initializes the clocksource and common timekeeping values.
</p>
</div>
</div>
<div id="outline-container-sec-3-16" class="outline-3">
<h3 id="sec-3-16"><code>time_init();</code></h3>
<div class="outline-text-3" id="text-3-16">
<p>
<code>/arch/arm/kernel/time.c</code>
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">setup_arch()</span>
system_timer = mdesc-&gt;timer;
system_timer-&gt;init();
</pre>
</div>
<p>
以ARM的mach-smdk2410为例,初始化 <code>timer_startval</code> , <code>timer_usec_ticks</code>
和安装 <code>IRQ_TIMER4</code>.
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #00ffff;">static</span> <span style="color: #98fb98;">void</span> <span style="color: #87cefa;">__init</span> s3c2410_timer_init (<span style="color: #98fb98;">void</span>)
{
  s3c2410_timer_setup();
  setup_irq(IRQ_TIMER4, &amp;s3c2410_timer_irq);
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-17" class="outline-3">
<h3 id="sec-3-17"><code>console_init();</code></h3>
<div class="outline-text-3" id="text-3-17">
<p>
HACK ALERT! This is early. We're enabling the console before we've
done PCI setups etc., and <code>console_init()</code> must be aware of this. But we
do want output early, in case something goes wrong.
</p>
</div>
</div>
<div id="outline-container-sec-3-18" class="outline-3">
<h3 id="sec-3-18"><code>lockdep_info();</code></h3>
<div class="outline-text-3" id="text-3-18">
<p>
=CONFIG<sub>LOCKDEP</sub>=打开,打印锁依赖信息.
</p>
</div>
</div>
<div id="outline-container-sec-3-19" class="outline-3">
<h3 id="sec-3-19"><code>mem_init();</code></h3>
<div class="outline-text-3" id="text-3-19">
<ul class="org-ul">
<li>free each online node memory.
</li>
<li>calculate the real number of pages we have in this system.

<p>
<code>get_free_pages()</code> can be used after <code>mem_init()</code>.
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-20" class="outline-3">
<h3 id="sec-3-20"><code>kmem_cache_init();</code></h3>
<div class="outline-text-3" id="text-3-20">
<p>
<code>/mm/slab.c</code>
Called after the page allocator have been initialised and before
<code>smp_init()</code>.
</p>

<ol class="org-ol">
<li>create the cache<sub>cache</sub>.
</li>
<li>create the kmalloc caches.
</li>
<li>Replace the bootstrap head arrays.
</li>
<li>Replace the bootstrap kmem<sub>list3's</sub>.
</li>
<li>resize the head arrays to their final sizes.

<p>
<code>kmalloc()</code> can be used after <code>kmem_cache_sizes_init()</code>
</p>
</li>
</ol>
</div>
</div>
<div id="outline-container-sec-3-21" class="outline-3">
<h3 id="sec-3-21"><code>calibrate_delay();</code></h3>
<div class="outline-text-3" id="text-3-21">
<p>
Calculate the "<code>loops_per_jiffy</code>" delay loop value and print it in
BogoMIPS.
</p>
</div>
</div>
<div id="outline-container-sec-3-22" class="outline-3">
<h3 id="sec-3-22">some inits</h3>
<div class="outline-text-3" id="text-3-22">
<div class="org-src-container">

<pre class="src src-c">pidmap_init();
pgtable_cache_init();
prio_tree_init();
anon_vma_init();
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-23" class="outline-3">
<h3 id="sec-3-23"><code>fork_init(num_physpages);</code></h3>
<div class="outline-text-3" id="text-3-23">
<p>
根据物理内存大小计算允许创建进程的数量.
The default maximum number of threads is set to a safe value: the
thread structures can take up at most half of memory.
</p>

<div class="org-src-container">

<pre class="src src-c">max_threads = mempages / (8 * THREAD_SIZE / PAGE_SIZE);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-24" class="outline-3">
<h3 id="sec-3-24"><code>proc_caches_init();</code></h3>
<div class="outline-text-3" id="text-3-24">
<p>
<code>kernel/fork.c</code>
</p>

<p>
Call <code>kmem_cache_create()</code> to create slab caches for <code>signal_act</code> (signal
action), <code>files_cache</code> (<code>files_struct</code>), <code>fs_cache</code> (<code>fs_struct</code>),
<code>vm_area_struct</code>, and <code>mm_struct</code>.
</p>
</div>
</div>
<div id="outline-container-sec-3-25" class="outline-3">
<h3 id="sec-3-25"><code>buffer_init(void)</code></h3>
<div class="outline-text-3" id="text-3-25">
<p>
<code>/fs/buffer.c</code>
Call <code>kmem_cache_create()</code> to create slab caches for <code>buffer_head</code>.
</p>
</div>
</div>
<div id="outline-container-sec-3-26" class="outline-3">
<h3 id="sec-3-26"><code>vfs_caches_init(num_physpages);</code></h3>
<div class="outline-text-3" id="text-3-26">
<p>
<code>vfs_caches_init(num_physpages);</code>
</p>

<ul class="org-ul">
<li>Call <code>kmem_cache_create()</code> to create slab caches for <code>names_cache</code>,
filp.
</li>
<li>Call <code>dcache_init()</code> to create the <code>dentry_cache</code> and
<code>dentry_hashtable</code>.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-27" class="outline-3">
<h3 id="sec-3-27"><code>signals_init();</code></h3>
<div class="outline-text-3" id="text-3-27">
<p>
<code>/kernel/signal.c</code>
</p>

<p>
Call <code>kmem_cache_create()</code> to create the "sigqueue" SLAB cache.
</p>
</div>
</div>
<div id="outline-container-sec-3-28" class="outline-3">
<h3 id="sec-3-28"><code>proc_root_init();</code></h3>
<div class="outline-text-3" id="text-3-28">
<p>
<code>linux/fs/proc/root.c</code>
</p>

<p>
For <code>CONFIG_PROC_FS</code> configurations:
</p>

<ul class="org-ul">
<li>call <code>proc_misc_init()</code>.
</li>
<li>mkdir <code>/proc/net</code>.
</li>
<li>for <code>CONFIG_SYSVIPC</code>, mkdir <code>/proc/sysvipc</code>.
</li>
<li>mkdir <code>/proc/fs</code>.
</li>
<li>mkdir <code>/proc/driver</code>.
</li>
<li>call <code>proc_tty_init()</code>.
</li>
<li>mkdir <code>/proc/bus</code>.
</li>
<li>for <code>CONFIG_SYSCTL</code>, mkdir <code>/proc/sys</code>.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3-29" class="outline-3">
<h3 id="sec-3-29"><code>check_bugs();</code></h3>
<div class="outline-text-3" id="text-3-29">
<p>
<code>include/asm-arm/bugs.h</code>
ARM仅仅做 <code>check_writebuffer_bugs()</code>.
</p>
</div>
</div>
<div id="outline-container-sec-3-30" class="outline-3">
<h3 id="sec-3-30"><code>rest_init();</code></h3>
<div class="outline-text-3" id="text-3-30">
<p>
Do the rest non-_<sub>init'ed</sub>, we're now alive 
</p>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><code>rest_init</code></h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">start init thread</h3>
<div class="outline-text-3" id="text-4-1">
<p>
We count on the initial thread going OK.
</p>

<p>
Like idlers, init is an unlocked kernel thread, which will make
syscalls (and thus be locked).
</p>

<div class="org-src-container">

<pre class="src src-c">kernel_thread(kernel_init, <span style="color: #7fffd4;">NULL</span>, CLONE_FS | CLONE_SIGHAND);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">create kthreadd thread</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">

<pre class="src src-c">pid = kernel_thread(kthreadd, <span style="color: #7fffd4;">NULL</span>, CLONE_FS | CLONE_FILES);
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><code>unlock_kernel();</code></h3>
<div class="outline-text-3" id="text-4-3">
<p>
Release the BKL.
</p>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><code>schedule();</code> and <code>cpu_idle();</code></h3>
<div class="outline-text-3" id="text-4-4">
<p>
This function remains as process number 0. Its purpose is to use up
idle CPU cycles. If the kernel is configured for APM support or ACPI
support, <code>cpu_idle()</code> invokes the supported power-saving features of
these specifications. Otherwise it nominally executes a "hlt"
instruction.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><code>setup_arch(&amp;command_line)</code></h2>
<div class="outline-text-2" id="text-5">
<p>
<code>/arch/arm/kernel/setup.c</code>
</p>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><code>setup_processor</code></h3>
<div class="outline-text-3" id="text-5-1">
<p>
use <code>processor_id</code> look up the processor type, and do the initials.
</p>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><code>setup_machine</code></h3>
<div class="outline-text-3" id="text-5-2">
<p>
use <code>machine_arch_type</code> look up the machine type, get the <code>struct
machine_desc *mdesc;</code>.
</p>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3">Set memory limits</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Set values for the start of kernel code, end of kernel code, end of
kernel data, and "<code>_end</code>" (end of kernel code = the "brk" address).
</p>
<div class="org-src-container">

<pre class="src src-c">init_mm.start_code = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>) &amp;_text;
init_mm.end_code   = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>) &amp;_etext;
init_mm.end_data   = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>) &amp;_edata;
init_mm.brk        = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>) &amp;_end;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><code>parse_cmdline(cmdline_p, from);</code></h3>
<div class="outline-text-3" id="text-5-4">
<p>
parsing of the command line.
</p>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><code>cpu_init();</code></h3>
<div class="outline-text-3" id="text-5-5">
<p>
<code>cpu_init</code> dumps the cache information, initialises SMP specific
information, and sets up the per-CPU stacks.
</p>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6">Set up various architecture-specific pointers</h3>
<div class="outline-text-3" id="text-5-6">
<div class="org-src-container">

<pre class="src src-c">init_arch_irq = mdesc-&gt;init_irq;
system_timer = mdesc-&gt;timer;
init_machine = mdesc-&gt;init_machine;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><code>kernel_init</code> thread</h2>
<div class="outline-text-2" id="text-6">
<p>
<code>/init/main.c</code>
</p>

<p>
The <code>kernel_init</code> thread begins at the <code>kernel_init()</code> function in
"<code>linux/init/main.c</code>". This is always expected to be process number 1.
</p>

<ul class="org-ul">
<li><code>kernel_init()</code> first locks the kernel.
</li>
<li>do some smp prepare and initials
<div class="org-src-container">

<pre class="src src-c">do_pre_smp_initcalls();
smp_init();
sched_init_smp();
cpuset_init_smp();
</pre>
</div>
</li>
<li>calls <code>do_basic_setup()</code> to perform lots of bus and device
initialization {more detail below}. After <code>do_basic_setup()</code>, most
kernel initialization has been completed.
</li>
<li><code>init_post();</code> call <code>free_initmem();</code> frees any memory that was
specified as being for initialization only [marked with "<code>__init</code>",
"<code>__initdata</code>", "<code>__init_call</code>", or "<code>__initsetup</code>"]
</li>
<li>unlocks the kernel (BKL).
</li>
<li><code>init_post();</code> next opens /dev/console and duplicates that file
descriptor two times to create stdin, stdout, and stderr files for
init and all of its children.
</li>
<li>Finally <code>init_post();</code> tries to execute the command specified on the
kernel parameters command line if there was one, or an init program
or script if it can find one in {/sbin/init, /etc/init, /bin/init},
and lastly /bin/sh. If <code>init_post();</code> cannot execute any of these,
it <code>panics("No init found. Try passing init= option to kernel.")</code>.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><code>do_basic_setup</code></h2>
<div class="outline-text-2" id="text-7">
<p>
The machine is now initialized. None of the devices have been touched
yet, but the CPU subsystem is up and running, and memory and process
management works.
</p>

<ul class="org-ul">
<li><code>init_workqueues();</code>
</li>
<li><code>usermodehelper_init();</code> : <code>khelper_wq =
  create_singlethread_workqueue("khelper");</code>
</li>
<li><code>driver_init();</code>: initial many devices and buses.
<div class="org-src-container">

<pre class="src src-c"><span style="color: #98fb98;">void</span> <span style="color: #87cefa;">__init</span> driver_init(<span style="color: #98fb98;">void</span>)
{
        <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">These are the core pieces </span><span style="color: #ff7f24;">*/</span>
  devices_init();
  buses_init();
  classes_init();
  firmware_init();
  hypervisor_init();

  platform_bus_init();
  system_bus_init();
  cpu_dev_init();
  memory_dev_init();
  attribute_container_init();
}
</pre>
</div>
</li>
<li><code>init_irq_proc();</code> : create /proc/irq.
</li>
<li><code>do_initcalls();</code>: Call all functions marked as "_<sub>initcall</sub>"
</li>
</ul>
</div>
<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><code>do_initcalls</code></h3>
<div class="outline-text-3" id="text-7-1">
<p>
<code>/init/main.c</code>, this initializes many functions and some subsystems.
The function is simple, just a loop call each initcall sub functions:
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #00ffff;">for</span> (call = __initcall_start; call &lt; __initcall_end; call++) {
}
</pre>
</div>
</div>
<ul class="org-ul"><li><a id="sec-7-1-1" name="sec-7-1-1"></a><code>__initcall_start</code> and <code>__initcall_end</code><br  /><div class="outline-text-4" id="text-7-1-1">
<p>
They are in <code>init</code> section, in arch/xxx/kernel/vmlinux.lds.S:
</p>
<div class="org-src-container">

<pre class="src src-c"> SECTIONS
 {
.init : {                       <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">Init code and data           </span><span style="color: #ff7f24;">*/</span>
     __initcall_start = .;
     <span style="color: #98fb98;">INITCALLS</span>
         <span style="color: #eedd82;">__initcall_end</span> = .;
   }
 }
</pre>
</div>
</div>
</li>
<li><a id="sec-7-1-2" name="sec-7-1-2"></a>INITCALLS<br  /><div class="outline-text-4" id="text-7-1-2">
<p>
It is defined in include/asm-generic/vmlinux.lds.h:
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #b0c4de;">#define</span> <span style="color: #eedd82;">INITCALLS</span>                                                       \
        *(.initcall0.init)                                              \
        *(.initcall0s.init)                                             \
        *(.initcall1.init)                                              \
        *(.initcall1s.init)                                             \
        *(.initcall2.init)                                              \
        *(.initcall2s.init)                                             \
        *(.initcall3.init)                                              \
        *(.initcall3s.init)                                             \
        *(.initcall4.init)                                              \
        *(.initcall4s.init)                                             \
        *(.initcall5.init)                                              \
        *(.initcall5s.init)                                             \
        *(.initcallrootfs.init)                                         \
        *(.initcall6.init)                                              \
        *(.initcall6s.init)                                             \
        *(.initcall7.init)                                              \
        *(.initcall7s.init)
</pre>
</div>
</div>
</li>
<li><a id="sec-7-1-3" name="sec-7-1-3"></a>initcall<br  /><div class="outline-text-4" id="text-7-1-3">
<p>
Linux内核代码中有很多初始化标志 <code>arch_initcall(fn)</code>,
<code>device_initcall(fn)</code> 等,它们的定义在include/linux/init.h中:
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">pure_initcall</span>(<span style="color: #eedd82;">fn</span>)               __define_initcall(<span style="color: #ffa07a;">"0"</span>,fn,0)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">core_initcall</span>(<span style="color: #eedd82;">fn</span>)               __define_initcall(<span style="color: #ffa07a;">"1"</span>,fn,1)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">core_initcall_sync</span>(<span style="color: #eedd82;">fn</span>)          __define_initcall(<span style="color: #ffa07a;">"1s"</span>,fn,1s)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">postcore_initcall</span>(<span style="color: #eedd82;">fn</span>)           __define_initcall(<span style="color: #ffa07a;">"2"</span>,fn,2)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">postcore_initcall_sync</span>(<span style="color: #eedd82;">fn</span>)      __define_initcall(<span style="color: #ffa07a;">"2s"</span>,fn,2s)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">arch_initcall</span>(<span style="color: #eedd82;">fn</span>)               __define_initcall(<span style="color: #ffa07a;">"3"</span>,fn,3)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">arch_initcall_sync</span>(<span style="color: #eedd82;">fn</span>)          __define_initcall(<span style="color: #ffa07a;">"3s"</span>,fn,3s)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">subsys_initcall</span>(<span style="color: #eedd82;">fn</span>)             __define_initcall(<span style="color: #ffa07a;">"4"</span>,fn,4)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">subsys_initcall_sync</span>(<span style="color: #eedd82;">fn</span>)        __define_initcall(<span style="color: #ffa07a;">"4s"</span>,fn,4s)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">fs_initcall</span>(<span style="color: #eedd82;">fn</span>)                 __define_initcall(<span style="color: #ffa07a;">"5"</span>,fn,5)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">fs_initcall_sync</span>(<span style="color: #eedd82;">fn</span>)            __define_initcall(<span style="color: #ffa07a;">"5s"</span>,fn,5s)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">rootfs_initcall</span>(<span style="color: #eedd82;">fn</span>)             __define_initcall(<span style="color: #ffa07a;">"rootfs"</span>,fn,rootfs)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">device_initcall</span>(<span style="color: #eedd82;">fn</span>)             __define_initcall(<span style="color: #ffa07a;">"6"</span>,fn,6)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">device_initcall_sync</span>(<span style="color: #eedd82;">fn</span>)        __define_initcall(<span style="color: #ffa07a;">"6s"</span>,fn,6s)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">late_initcall</span>(<span style="color: #eedd82;">fn</span>)               __define_initcall(<span style="color: #ffa07a;">"7"</span>,fn,7)
<span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">late_initcall_sync</span>(<span style="color: #eedd82;">fn</span>)          __define_initcall(<span style="color: #ffa07a;">"7s"</span>,fn,7s)
</pre>
</div>

<p>
<code>__define_initcall</code> 是个宏,如下:
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #b0c4de;">#define</span> <span style="color: #87cefa;">__define_initcall</span>(<span style="color: #eedd82;">level</span>,<span style="color: #eedd82;">fn</span>,<span style="color: #eedd82;">id</span>) \
        <span style="color: #00ffff;">static</span> <span style="color: #98fb98;">initcall_t</span> <span style="color: #87cefa;">__initcall_</span>##fn##id __attribute_used__ \
        <span style="color: #00ffff;">__attribute__</span>((__section__(<span style="color: #ffa07a;">".initcall"</span> level <span style="color: #ffa07a;">".init"</span>))) = fn

<span style="color: #00ffff;">typedef</span> <span style="color: #98fb98;">int</span> (*<span style="color: #98fb98;">initcall_t</span>)(<span style="color: #98fb98;">void</span>);
</pre>
</div>
<ul class="org-ul">
<li><code>initcall</code> 是函数指针,所以定义了名为 <code>__initcall_##fn##id</code> 的函数指针.
</li>

<li>函数指针指向函数fn.
</li>
<li><code>__attribute__((__section__(".initcall" level ".init"))</code> 表示编译的时候把这个函数指针变量放置到名为 <code>(".initcall" level ".init")</code> 的
section中.
</li>
</ul>
</div>
</li></ul>
</div>
</div>


<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">reference</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><code>cpu_idle</code></h3>
<div class="outline-text-3" id="text-8-1">
<p>
<a id="cpu_idle" name="cpu_idle"></a>
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #98fb98;">void</span> <span style="color: #87cefa;">cpu_idle</span>(<span style="color: #98fb98;">void</span>) {
  local_fiq_enable();
  <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">endless idle loop with no priority at all </span><span style="color: #ff7f24;">*/</span>
  <span style="color: #00ffff;">while</span> (1) {
    <span style="color: #98fb98;">void</span> (*<span style="color: #eedd82;">idle</span>)(<span style="color: #98fb98;">void</span>) = pm_idle;
    <span style="color: #00ffff;">if</span> (!idle)
      idle = default_idle;
    leds_event(led_idle_start);
    tick_nohz_stop_sched_tick();
    <span style="color: #00ffff;">while</span> (!need_resched())
      idle();
    leds_event(led_idle_end);
    tick_nohz_restart_sched_tick();
    preempt_enable_no_resched();
    schedule();
    preempt_disable();
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><code>setup_arch</code></h3>
<div class="outline-text-3" id="text-8-2">
<p>
<a id="setup_arch" name="setup_arch"></a>
<code>arch/arm/kernel/setup.c</code>
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #98fb98;">void</span> <span style="color: #87cefa;">__init</span> setup_arch(<span style="color: #98fb98;">char</span> **<span style="color: #eedd82;">cmdline_p</span>)
{
        <span style="color: #00ffff;">struct</span> <span style="color: #98fb98;">tag</span> *<span style="color: #eedd82;">tags</span> = (<span style="color: #00ffff;">struct</span> <span style="color: #98fb98;">tag</span> *)&amp;init_tags;
        <span style="color: #00ffff;">struct</span> <span style="color: #98fb98;">machine_desc</span> *<span style="color: #eedd82;">mdesc</span>;
        <span style="color: #98fb98;">char</span> *<span style="color: #eedd82;">from</span> = default_command_line;

        setup_processor();
        mdesc = setup_machine(machine_arch_type);
        machine_name = mdesc-&gt;name;

        <span style="color: #00ffff;">if</span> (mdesc-&gt;soft_reboot)
                reboot_setup(<span style="color: #ffa07a;">"s"</span>);

        <span style="color: #00ffff;">if</span> (__atags_pointer)
                tags = phys_to_virt(__atags_pointer);
        <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (mdesc-&gt;boot_params)
                tags = phys_to_virt(mdesc-&gt;boot_params);

<span style="color: #b0c4de;">#ifdef</span> CONFIG_KEXEC
        kexec_boot_params_copy = virt_to_phys(kexec_boot_params_buf);
        kexec_boot_params = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>)kexec_boot_params_buf;
        <span style="color: #00ffff;">if</span> (__atags_pointer) {
                kexec_boot_params_address = __atags_pointer;
                memcpy((<span style="color: #98fb98;">void</span> *)kexec_boot_params, tags, KEXEC_BOOT_PARAMS_SIZE);
        } <span style="color: #00ffff;">else</span> <span style="color: #00ffff;">if</span> (mdesc-&gt;boot_params) {
                kexec_boot_params_address = mdesc-&gt;boot_params;
                memcpy((<span style="color: #98fb98;">void</span> *)kexec_boot_params, tags, KEXEC_BOOT_PARAMS_SIZE);
        }
<span style="color: #b0c4de;">#endif</span>

        <span style="color: #ff7f24;">/*</span>
<span style="color: #ff7f24;">         * If we have the old style parameters, convert them to</span>
<span style="color: #ff7f24;">         * a tag list.</span>
<span style="color: #ff7f24;">         </span><span style="color: #ff7f24;">*/</span>
        <span style="color: #00ffff;">if</span> (tags-&gt;hdr.tag != ATAG_CORE)
                convert_to_tag_list(tags);
        <span style="color: #00ffff;">if</span> (tags-&gt;hdr.tag != ATAG_CORE)
                tags = (<span style="color: #00ffff;">struct</span> <span style="color: #98fb98;">tag</span> *)&amp;init_tags;

        <span style="color: #00ffff;">if</span> (mdesc-&gt;fixup)
                mdesc-&gt;fixup(mdesc, tags, &amp;from, &amp;meminfo);

        <span style="color: #00ffff;">if</span> (tags-&gt;hdr.tag == ATAG_CORE) {
                <span style="color: #00ffff;">if</span> (meminfo.nr_banks != 0)
                        squash_mem_tags(tags);
                parse_tags(tags);
        }

        init_mm.start_code = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>) &amp;_text;
        init_mm.end_code   = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>) &amp;_etext;
        init_mm.end_data   = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>) &amp;_edata;
        init_mm.brk        = (<span style="color: #98fb98;">unsigned</span> <span style="color: #98fb98;">long</span>) &amp;_end;

        memcpy(boot_command_line, from, COMMAND_LINE_SIZE);
        boot_command_line[COMMAND_LINE_SIZE-1] = <span style="color: #ffa07a;">'\0'</span>;
        parse_cmdline(cmdline_p, from);
        paging_init(&amp;meminfo, mdesc);
        request_standard_resources(&amp;meminfo, mdesc);

<span style="color: #b0c4de;">#ifdef</span> CONFIG_SMP
        smp_init_cpus();
<span style="color: #b0c4de;">#endif</span>

        cpu_init();

        <span style="color: #ff7f24;">/*</span>
<span style="color: #ff7f24;">         * Set up various architecture-specific pointers</span>
<span style="color: #ff7f24;">         </span><span style="color: #ff7f24;">*/</span>
        init_arch_irq = mdesc-&gt;init_irq;
        system_timer = mdesc-&gt;timer;
        init_machine = mdesc-&gt;init_machine;

<span style="color: #b0c4de;">#ifdef</span> CONFIG_VT
<span style="color: #b0c4de;">#if</span> <span style="color: #b0c4de;">defined</span>(CONFIG_VGA_CONSOLE)
        conswitchp = &amp;vga_con;
<span style="color: #b0c4de;">#elif</span> <span style="color: #b0c4de;">defined</span>(CONFIG_DUMMY_CONSOLE)
        conswitchp = &amp;dummy_con;
<span style="color: #b0c4de;">#endif</span>
<span style="color: #b0c4de;">#endif</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><code>kernel_init</code></h3>
<div class="outline-text-3" id="text-8-3">
<p>
<code>/init/main.c</code>
</p>
<div class="org-src-container">

<pre class="src src-c"><span style="color: #00ffff;">static</span> <span style="color: #98fb98;">int</span> <span style="color: #87cefa;">__init</span> kernel_init(<span style="color: #98fb98;">void</span> * <span style="color: #eedd82;">unused</span>)
{
  lock_kernel();
  set_cpus_allowed(current, CPU_MASK_ALL);
  init_pid_ns.child_reaper = current;

  __set_special_pids(1, 1);
  cad_pid = task_pid(current);

  smp_prepare_cpus(max_cpus);

  do_pre_smp_initcalls();

  smp_init();
  sched_init_smp();

  cpuset_init_smp();

  do_basic_setup();

  <span style="color: #00ffff;">if</span> (!ramdisk_execute_command)
    ramdisk_execute_command = <span style="color: #ffa07a;">"/init"</span>;

  <span style="color: #00ffff;">if</span> (sys_access((<span style="color: #00ffff;">const</span> <span style="color: #98fb98;">char</span> <span style="color: #eedd82;">__user</span> *) ramdisk_execute_command, 0) != 0) {
    ramdisk_execute_command = <span style="color: #7fffd4;">NULL</span>;
    prepare_namespace();
  }
  init_post();
  <span style="color: #00ffff;">return</span> 0;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4"><code>init_post</code></h3>
<div class="outline-text-3" id="text-8-4">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #00ffff;">static</span> <span style="color: #98fb98;">int</span> <span style="color: #87cefa;">noinline</span> init_post(<span style="color: #98fb98;">void</span>)
{
  free_initmem();
  unlock_kernel();
  mark_rodata_ro();
  system_state = SYSTEM_RUNNING;
  numa_default_policy();

  <span style="color: #00ffff;">if</span> (sys_open((<span style="color: #00ffff;">const</span> <span style="color: #98fb98;">char</span> <span style="color: #eedd82;">__user</span> *) <span style="color: #ffa07a;">"/dev/console"</span>, O_RDWR, 0) &lt; 0)
    printk(KERN_WARNING <span style="color: #ffa07a;">"Warning: unable to open an initial console.\n"</span>);

  (<span style="color: #98fb98;">void</span>) sys_dup(0);
  (<span style="color: #98fb98;">void</span>) sys_dup(0);

  <span style="color: #00ffff;">if</span> (ramdisk_execute_command) {
          run_init_process(ramdisk_execute_command);
          printk(KERN_WARNING <span style="color: #ffa07a;">"Failed to execute %s\n"</span>,
                 ramdisk_execute_command);
  }

  <span style="color: #00ffff;">if</span> (execute_command) {
    run_init_process(execute_command);
    printk(KERN_WARNING <span style="color: #ffa07a;">"Failed to execute %s.  Attempting "</span>
           <span style="color: #ffa07a;">"defaults...\n"</span>, execute_command);
  }
  run_init_process(<span style="color: #ffa07a;">"/sbin/init"</span>);
  run_init_process(<span style="color: #ffa07a;">"/etc/init"</span>);
  run_init_process(<span style="color: #ffa07a;">"/bin/init"</span>);
  run_init_process(<span style="color: #ffa07a;">"/bin/sh"</span>);

  panic(<span style="color: #ffa07a;">"No init found.  Try passing init= option to kernel."</span>);
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5"><code>do_basic_setup</code></h3>
<div class="outline-text-3" id="text-8-5">
<div class="org-src-container">

<pre class="src src-c"><span style="color: #00ffff;">static</span> <span style="color: #98fb98;">void</span> <span style="color: #87cefa;">__init</span> do_basic_setup(<span style="color: #98fb98;">void</span>)
{
  init_workqueues();
  usermodehelper_init();
  driver_init();
  init_irq_proc();
  do_initcalls();
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">cc</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-c"></pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Shi Shougang</p>
<p class="date">Created: 2015-03-05 Thu 23:20</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
