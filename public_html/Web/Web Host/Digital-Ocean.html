<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Digital Ocean</title>
<!-- 2015-03-05 Thu 23:19 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Shi Shougang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link href="../../assets/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="../../assets/bootstrap-responsive.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../assets/stylesheet.css" />
<script src="assets/js/bootstrap.min.js"></script>

<script type="text/javascript" src="assets/js/org-info.js">
/**
 *
 * @source: assets/js/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in assets/js/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in assets/js/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "2");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "0");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "#dddddd");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "showall");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Digital Ocean</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Set Up SSH Keys</a>
<ul>
<li><a href="#sec-1-1">Create the RSA key pair on the client machine</a></li>
<li><a href="#sec-1-2">Copy the Public Key</a></li>
<li><a href="#sec-1-3">[Optional] Disable the Password for Root Login</a></li>
</ul>
</li>
<li><a href="#sec-2">Setting up a new user</a>
<ul>
<li><a href="#sec-2-1">Create a New User</a></li>
<li><a href="#sec-2-2">add Root Privileges to the New User</a></li>
<li><a href="#sec-2-3">Configure SSH (OPTIONAL)</a></li>
<li><a href="#sec-2-4">Reload and Done</a></li>
</ul>
</li>
<li><a href="#sec-3">SFTP and SCP</a>
<ul>
<li><a href="#sec-3-1">SCP</a></li>
<li><a href="#sec-3-2">SFTP</a></li>
</ul>
</li>
<li><a href="#sec-4">Security</a>
<ul>
<li><a href="#sec-4-1">How To Protect SSH with fail2ban on Ubuntu 12.04</a></li>
<li><a href="#sec-4-2">How To Install DenyHosts on Ubuntu 12.04</a></li>
</ul>
</li>
<li><a href="#sec-5">How To Add Swap on Ubuntu 12.04</a>
<ul>
<li><a href="#sec-5-1">Check for Swap Space</a></li>
<li><a href="#sec-5-2">Create and Enable the Swap File</a></li>
<li><a href="#sec-5-3">More Setting</a></li>
</ul>
</li>
<li><a href="#sec-6">How To Install Linux, nginx, MySQL, PHP (LEMP) stack on Ubuntu 12.04</a>
<ul>
<li><a href="#sec-6-1">Update Apt-Get</a></li>
<li><a href="#sec-6-2">Install MySQL</a></li>
<li><a href="#sec-6-3">Install nginx</a></li>
<li><a href="#sec-6-4">Install PHP</a></li>
<li><a href="#sec-6-5">Configure php</a></li>
<li><a href="#sec-6-6">Configure nginx</a></li>
<li><a href="#sec-6-7">Create a php Info Page for Test[option]</a></li>
</ul>
</li>
<li><a href="#sec-7">Migrate Wordpress to Nginx</a>
<ul>
<li><a href="#sec-7-1">Restore Database</a></li>
<li><a href="#sec-7-2">Basic NGINX Optimization</a></li>
<li><a href="#sec-7-3">Creating NGINX .conf files</a></li>
<li><a href="#sec-7-4">Creating Server Blocks</a></li>
<li><a href="#sec-7-5">Restore Wordpress Files</a></li>
</ul>
</li>
<li><a href="#sec-8">MySQL Tips</a>
<ul>
<li><a href="#sec-8-1">list MySQL user</a></li>
<li><a href="#sec-8-2">Create and Delete a MySQL Database</a></li>
<li><a href="#sec-8-3">Access a MySQL Database</a></li>
<li><a href="#sec-8-4">Create a MySQL Table</a></li>
<li><a href="#sec-8-5">Add Information to a MySQL Table</a></li>
<li><a href="#sec-8-6">Update Information in the Table</a></li>
<li><a href="#sec-8-7">Add and Delete a Column</a></li>
<li><a href="#sec-8-8">Delete a Row</a></li>
</ul>
</li>
<li><a href="#sec-9">How To Create a SSL Certificate on nginx for Ubuntu 12.04</a>
<ul>
<li><a href="#sec-9-1">Create a Directory for the Certificate</a></li>
<li><a href="#sec-9-2">Create the Server Key and Certificate Signing Request</a></li>
<li><a href="#sec-9-3">Remove the Passphrase</a></li>
<li><a href="#sec-9-4">Sign your SSL Certificate</a></li>
<li><a href="#sec-9-5">Set Up the Certificate for Test [option]</a></li>
<li><a href="#sec-9-6">Activate the Virtual Host</a></li>
</ul>
</li>
<li><a href="#sec-10">Nginx and PHP5-FPM Configuration and Optimizing Tips</a>
<ul>
<li><a href="#sec-10-1">high memory of php5-fpm</a></li>
<li><a href="#sec-10-2">Nginx</a></li>
<li><a href="#sec-10-3">PHP5-FPM</a></li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Set Up SSH Keys</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Create the RSA key pair on the client machine</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">

<pre class="src src-sh">ssh-keygen -t rsa
Enter file<span style="color: #00ffff;"> in</span> which to save the key (/home/demo/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">Copy the Public Key</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">1 use ssh-copy-id command</span>
ssh-copy-id user@123.45.56.78
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">2 use SSH</span>
cat ~/.ssh/id_rsa.pub | ssh user@123.45.56.78 <span style="color: #ffa07a;">"cat &gt;&gt; ~/.ssh/authorized_keys"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">[Optional] Disable the Password for Root Login</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">

<pre class="src src-sh">sudo nano /etc/ssh/sshd_config
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">fine the line that includes PermitRootLogin and modify it</span>
PermitRootLogin without-password
reload ssh
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Setting up a new user<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup></h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Create a New User</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-sh">adduser demo
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">add Root Privileges to the New User</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">

<pre class="src src-sh">visudo

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">User privilege specification</span>
root    <span style="color: #eedd82;">ALL</span>=(ALL:ALL) ALL
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Under there, add the following line, granting all the permissions to your new user</span>
demo    <span style="color: #eedd82;">ALL</span>=(ALL:ALL) ALL
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Configure SSH (OPTIONAL)</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">

<pre class="src src-sh">nano /etc/ssh/sshd_config
Port 25000
Protocol 2
PermitRootLogin no
</pre>
</div>
<p>
<b>PermitRootLogin</b>: change this from yes to no to stop future root login.
You will now only be logging on as the new user.
</p>


<p>
Add these lines to the bottom of the document, replacing <b>demo</b> in the
AllowUsers line with your username. (AllowUsers will limit login to
only the users on that line. To avoid this, skip this line):
</p>
<div class="org-src-container">

<pre class="src src-sh">UseDNS no
AllowUsers demo
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">Reload and Done</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">

<pre class="src src-sh">reload ssh
ssh -p 25000 demo@123.45.67.890
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">SFTP and SCP</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">SCP</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">

<pre class="src src-sh">scp ~/Downloads/backup_db.sql.gz username@server_ip_address:
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">SFTP</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">

<pre class="src src-sh">sftp username@remote_hostname_or_IP
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">download files from our remote host</span>
get remoteFile
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Transferring files to the remote system</span>
put localFile
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Security</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">How To Protect SSH with fail2ban on Ubuntu 12.04<sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup></h3>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">How To Install DenyHosts on Ubuntu 12.04<sup><a id="fnr.3" name="fnr.3" class="footref" href="#fn.3">3</a></sup></h3>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">How To Add Swap on Ubuntu 12.04<sup><a id="fnr.4" name="fnr.4" class="footref" href="#fn.4">4</a></sup></h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">Check for Swap Space</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">

<pre class="src src-sh">sudo swapon -s
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">An empty list will confirm that you have no swap files enabled:</span>
Filename                                Type            Size    Used    Priority
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">Create and Enable the Swap File</h3>
<div class="outline-text-3" id="text-5-2">
<p>
1024*512k=512M swap space
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo dd <span style="color: #eedd82;">if</span>=/dev/zero <span style="color: #eedd82;">of</span>=/swapfile <span style="color: #eedd82;">bs</span>=1024 <span style="color: #eedd82;">count</span>=512k
sudo mkswap /swapfile
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">The results display:</span>
Setting up swapspace version 1, <span style="color: #eedd82;">size</span> = 262140 KiB
no label, <span style="color: #eedd82;">UUID</span>=103c4545-5fc5-47f3-a8b3-dfbdb64fd7eb
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Finish up by activating the swap file:</span>
sudo swapon /swapfile
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">You will then be able to see the new swap file when you view the swap summary.</span>
swapon -s
Filename                                Type            Size    Used    Priority
/swapfile                               file            262140  0       -1
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">the swap is permanent by adding it to the fstab file</span>
sudo nano /etc/fstab
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Paste in the following line:</span>
 /swapfile       none    swap    sw      0       0
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3">More Setting</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Swappiness in the file should be set to 0. Skipping this step may
cause both poor performance, whereas setting it to 0 will cause swap
to act as an emergency buffer, preventing out-of-memory crashes.
</p>

<p>
You can do this with the following commands:
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b0c4de;">echo</span> 0 | sudo tee /proc/sys/vm/swappiness
<span style="color: #b0c4de;">echo</span> vm.swappiness = 0 | sudo tee -a /etc/sysctl.conf
</pre>
</div>

<p>
To prevent the file from being world-readable, set up the correct
permissions on the swap file:
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo chown root:root /swapfile 
sudo chmod 0600 /swapfile
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">How To Install Linux, nginx, MySQL, PHP (LEMP) stack on Ubuntu 12.04<sup><a id="fnr.5" name="fnr.5" class="footref" href="#fn.5">5</a></sup></h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1">Update Apt-Get</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">

<pre class="src src-sh">sudo apt-get update
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2">Install MySQL</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install mysql-server mysql-client
</pre>
</div>
</div>

<ul class="org-ul"><li><a id="sec-6-2-1" name="sec-6-2-1"></a>configuration<br  /><div class="outline-text-4" id="text-6-2-1">
<p>
Once you have installed MySQL, we should activate it with this
command:
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo mysql_install_db
</pre>
</div>

<p>
Finish up by running the MySQL set up script:
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo /usr/bin/mysql_secure_installation
</pre>
</div>

<p>
It’s easiest just to say Yes to all the options. At the end, MySQL
will reload and implement the new changes.
</p>
<div class="org-src-container">

<pre class="src src-sh">By default, a MySQL installation has an anonymous user, allowing anyone
to log into MySQL without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] y                                            
 ... Success!

Normally, root should only be allowed to connect from <span style="color: #ffa07a;">'localhost'</span>.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] y
... Success!

By default, MySQL comes with a database named <span style="color: #ffa07a;">'test'</span> that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] y
 - Dropping test database...
 ... Success!
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] y
 ... Success!

Cleaning up...
</pre>
</div>
</div>
</li></ul>
</div>
<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3">Install nginx</h3>
<div class="outline-text-3" id="text-6-3">
<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install nginx
</pre>
</div>

<p>
start nginx
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo service nginx start
</pre>
</div>

<p>
You can confirm that nginx has installed an your web server by
directing your browser to your IP address. You can run the following
command to reveal your VPS's IP address.
</p>
<div class="org-src-container">

<pre class="src src-sh">ifconfig eth0 | grep inet | awk <span style="color: #ffa07a;">'{ print $2 }'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4">Install PHP</h3>
<div class="outline-text-3" id="text-6-4">
<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install php5-fpm
sudo apt-get install php5-mysql php5-gd php5-xdebug php-apc
</pre>
</div>
<p>
php5-gd: This package provides a module for handling graphics directly
from PHP scripts. It supports the PNG, JPEG, XPM formats as well as
Freetype/ttf fonts.
</p>

<p>
More:
</p>
<ul class="org-ul">
<li>APC (php-pecl-apc) – APC caches and optimizes PHP intermediate code
</li>
<li>CLI (php-cli) – Command-line interface for PHP
</li>
<li>PEAR (php-pear) – PHP Extension and Application Repository framework
</li>
<li>PDO (php-pdo) – A database access abstraction module for PHP applications
</li>
<li>MySQL (php-mysqlnd) – A module for PHP applications that use MySQL databases
</li>
<li>PostgreSQL (php-pgsql) – A PostgreSQL database module for PHP
</li>
<li>MongoDB (php-pecl-mongo) – PHP MongoDB database driver
</li>
<li>SQLite (php-sqlite) – Extension for the SQLite V2 Embeddable SQL Database Engine
</li>
<li>Memcache (php-pecl-memcache) – Extension to work with the Memcached caching daemon
</li>
<li>Memcached (php-pecl-memcached) – Extension to work with the Memcached caching daemon
</li>
<li>GD (php-gd) – A module for PHP applications for using the gd graphics library
</li>
<li>XML (php-xml) – A module for PHP applications which use XML
</li>
<li>MBString (php-mbstring) – A module for PHP applications which need multi-byte string handling
</li>
<li>MCrypt (php-mcrypt) – Standard PHP module provides mcrypt library support
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-5" class="outline-3">
<h3 id="sec-6-5">Configure php</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">

<pre class="src src-sh">sudo nano /etc/php5/fpm/php.ini
cgi.fix_pathinfo=0
</pre>
</div>
<p>
Find the line, cgi.fix<sub>pathinfo</sub>=1, and change the 1 to 0.
</p>

<p>
If this number is kept as 1, the php interpreter will do its best to
process the file that is as near to the requested file as possible.
This is a possible security risk. If this number is set to 0,
conversely, the interpreter will only process the exact file path—a
much safer alternative.
</p>

<p>
We need to make another small change in the php5-fpm configuration.
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo nano /etc/php5/fpm/pool.d/www.conf
<span style="color: #eedd82;">listen</span> = /var/run/php5-fpm.sock
sudo service php5-fpm restart
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-6" class="outline-3">
<h3 id="sec-6-6">Configure nginx</h3>
<div class="outline-text-3" id="text-6-6">
<div class="org-src-container">

<pre class="src src-sh">sudo nano /etc/nginx/sites-available/default

server {
        listen   80;

        root /usr/share/nginx/www;
        index index.html index.htm index.php;

        server_name yourdomain.com www.yourdomain.com;

        location / {
                <span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">try to find the requested uri or redirect to index.php with request args</span>
                try_files $<span style="color: #eedd82;">uri</span> $<span style="color: #eedd82;">uri</span>/ /index.php?$<span style="color: #eedd82;">args</span>;
        }

        error_page 404 /404.html;

        error_page 500 502 503 504 /50x.html;
        <span style="color: #eedd82;">location</span> = /50x.html {
                root /usr/share/nginx/www;
        }

        <span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
        <span style="color: #ff7f24;">#</span>
        location ~ <span style="color: #ffa07a;">\.</span>php$ {
                fastcgi_split_path_info ^(.+<span style="color: #ffa07a;">\.</span>php)(/.+)$;
                fastcgi_pass unix:/var/run/php5-fpm.sock;
                fastcgi_index index.php;
                include fastcgi_params;
        }

}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-7" class="outline-3">
<h3 id="sec-6-7">Create a php Info Page for Test[option]</h3>
<div class="outline-text-3" id="text-6-7">
<div class="org-src-container">

<pre class="src src-sh">sudo nano /usr/share/nginx/www/info.php
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Add in the following line:</span>
&lt;?php
<span style="color: #87cefa;">phpinfo</span>();
?&gt;
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Restart nginx</span>
sudo service nginx restart
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">visiting http://youripaddress/info.php</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Migrate Wordpress to Nginx<sup><a id="fnr.6" name="fnr.6" class="footref" href="#fn.6">6</a></sup><sup>, </sup><sup><a id="fnr.7" name="fnr.7" class="footref" href="#fn.7">7</a></sup></h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">Restore Database</h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">

<pre class="src src-sh">mysql -u root -p
CREATE DATABASE wordpress;
CREATE USER wordpressuser@localhost;
SET PASSWORD FOR wordpressuser@<span style="color: #eedd82;">localhost</span>= PASSWORD(<span style="color: #ffa07a;">"password"</span>);
GRANT ALL PRIVILEGES ON wordpress.* TO wordpressuser@localhost;
FLUSH PRIVILEGES;
mysql -h localhost -u wordpressuser  -p wordpress &lt; ./wordpress.sql
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">Basic NGINX Optimization</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Increase or decrease the number of workers depending on your system's
specs:
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo nano /etc/nginx/nginx.conf
worker_processes 1;
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">NGINX limits the number of connections that a worker can maintain at one time, if your websites have many visitors you might want to increase the limit of connections</span>
worker_connections 768;
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Enabling Gzip</span>
gzip on;
gzip_types text/css text/x-component application/x-javascript application/javascript text/javascript text/x-js text/richtext image/svg+xml text/plain text/xsd text/xsl text/xml image/x-icon;
</pre>
</div>
<p>
Files can be compressed using Gzip to accelerate WordPress, the
smaller the data size requested by the user, the faster the response.
Think about CSS files &amp; HTML files, they have many similar strings,
repeated text and white spaces.
</p>
</div>
</div>
<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3">Creating NGINX .conf files</h3>
<div class="outline-text-3" id="text-7-3">
<p>
create 3 files that will hold our configurations:
</p>

<ul class="org-ul">
<li>common.conf: Configurations applicable to all sites.
</li>
<li>wordpress.conf: Configurations applicable to all WordPress sites.
</li>
<li>multisite.conf: Special configurations for WordPress multisite with
sub-directories.
</li>
</ul>
</div>
<ul class="org-ul"><li><a id="sec-7-3-1" name="sec-7-3-1"></a>create the dir<br  /><div class="outline-text-4" id="text-7-3-1">
<div class="org-src-container">

<pre class="src src-sh">sudo mkdir /etc/nginx/global
<span style="color: #b0c4de;">cd</span> /etc/nginx/global
</pre>
</div>
</div>
</li>
<li><a id="sec-7-3-2" name="sec-7-3-2"></a>common.conf file<br  /><div class="outline-text-4" id="text-7-3-2">
<div class="org-src-container">

<pre class="src src-sh">sudo nano common.conf

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">Global configuration file.</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">ESSENTIAL : Configure Nginx Listening Port</span>
listen 80;
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">ESSENTIAL : Default file to serve. If the first file isn't found, </span>
index index.php index.html index.htm;
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">ESSENTIAL : no favicon logs</span>
<span style="color: #eedd82;">location</span> = /favicon.ico {
    log_not_found off;
    access_log off;
}
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">ESSENTIAL : robots.txt</span>
<span style="color: #eedd82;">location</span> = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
}
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">ESSENTIAL : Configure 404 Pages</span>
error_page 404 /404.html;
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">ESSENTIAL : Configure 50x Pages</span>
error_page 500 502 503 504 /50x.html;
    <span style="color: #eedd82;">location</span> = /50x.html {
        root /usr/share/nginx/www;
    }
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">SECURITY : Deny all attempts to access hidden files .abcde</span>
location ~ /<span style="color: #ffa07a;">\.</span> {
    deny all;
}
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">PERFORMANCE : Set expires headers for static files and turn off logging.</span>
location ~* ^.+<span style="color: #ffa07a;">\.</span>(js|css|swf|xml|txt|ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
    access_log off; log_not_found off; expires 30d;
}
</pre>
</div>

<p>
<code>location = /robots.txt {allow all;}</code> allows the access to robots.txt,
if you want to specify another directory for the robots.txt you can
add an alias:
</p>

<div class="org-src-container">

<pre class="src src-sh">location /robots.txt {
    <span style="color: #b0c4de;">alias</span> /var/www/example.com/public/sample_robots.txt;
}
</pre>
</div>
<p>
<code>location ~ /\. {deny all;}</code> in the Linux operating system a hidden
file begins with a ".", access to some hidden files, such as
<code>.htaccess</code>, should be blocked for security reasons.
</p>


<p>
<code>location ~* ^.+\.(js|css|swf...</code> expires headers tell the browser
whether they should request a specific file from the server or whether
they should grab it from the browser's cache. With expires 30d we are
telling the browser to store static files such as pictures for 30
days.
</p>
</div>
</li>

<li><a id="sec-7-3-3" name="sec-7-3-3"></a>wordpress.conf file<br  /><div class="outline-text-4" id="text-7-3-3">
<div class="org-src-container">

<pre class="src src-sh">sudo nano wordpress.conf

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">WORDPRESS : Rewrite rules, sends everything through index.php and keeps the appended query string intact</span>
location / {
    try_files $<span style="color: #eedd82;">uri</span> $<span style="color: #eedd82;">uri</span>/ /index.php?<span style="color: #eedd82;">q</span>=$<span style="color: #eedd82;">uri</span>&amp;$<span style="color: #eedd82;">args</span>;
}

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">SECURITY : Deny all attempts to access PHP Files in the uploads directory</span>
location ~* /(?:uploads|files)/.*<span style="color: #ffa07a;">\.</span>php$ {
    deny all;
}
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">REQUIREMENTS : Enable PHP Support</span>
location ~ <span style="color: #ffa07a;">\.</span>php$ {
    <span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">SECURITY : Zero day Exploit Protection</span>
    try_files $<span style="color: #eedd82;">uri</span> =404;
    <span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">ENABLE : Enable PHP, listen fpm sock</span>
    fastcgi_split_path_info ^(.+<span style="color: #ffa07a;">\.</span>php)(/.+)$;
    fastcgi_pass unix:/var/run/php5-fpm.sock;
    fastcgi_index index.php;
    include fastcgi_params;
}
</pre>
</div>

<p>
<code>try_files $uri $uri/ /index.php?q=$uri&amp;$args</code> rewrite rule required
to allow you to choose your custom permalink structure on WordPress.
</p>

<p>
<code>location ~* /(?:uploads|files)/.*\.php$ {deny all;}</code> this will
prevent malicious code from being uploaded and executed from the
WordPress media directory.
</p>

<p>
<code>location ~ \.php$ {...}</code> since WordPress is a php site, we need to
tell NGINX how to a pass our php scripts to PHP5.
</p>

<p>
<code>try_files $uri =404;</code> this is a security rule, you only want to
either serve a determined php file or go to a 404 error.
</p>
</div>
</li>

<li><a id="sec-7-3-4" name="sec-7-3-4"></a>multisite.conf file<br  /><div class="outline-text-4" id="text-7-3-4">
<div class="org-src-container">

<pre class="src src-sh">sudo nano multisite.conf

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">Rewrite rules for WordPress Multi-site.</span>
<span style="color: #00ffff;">if</span> (!-e $<span style="color: #eedd82;">request_filename</span>) {
rewrite /wp-admin$ $<span style="color: #eedd82;">scheme</span>://$<span style="color: #eedd82;">host</span>$<span style="color: #eedd82;">uri</span>/ permanent;
rewrite ^/[_0-9a-zA-Z-]+(/wp-.*) $<span style="color: #eedd82;">1</span> last;
rewrite ^/[_0-9a-zA-Z-]+(/.*<span style="color: #ffa07a;">\.</span>php)$ $<span style="color: #eedd82;">1</span> last;
}
</pre>
</div>
</div>
</li></ul>
</div>

<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4">Creating Server Blocks</h3>
<div class="outline-text-3" id="text-7-4">
<p>
Have two blogs: <code>blog.dreamrunner.org</code> and <code>other.dreamrunner.org</code>.
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">disable the default server block:</span>
sudo rm /etc/nginx/sites-enabled/default

<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">And create a server block file:</span>
sudo nano /etc/nginx/sites-available/dreamrun
</pre>
</div>
<p>
Add:
</p>
<div class="org-src-container">

<pre class="src src-sh">server {
    server_name blog.dreamrunner.org;
    root /home/shougang/www/laogangzhi;
    access_log /var/log/nginx/blog.dreamrunner.org.access.log;
    error_log /var/log/nginx/blog.dreamrunner.org.error.log;
    include global/common.conf;
    include global/wordpress.conf;
    include global/multisite.conf;
}

server {
    server_name other.dreamrunner.org;
    root /home/shougang/www/dreamrunner;
    access_log /var/log/nginx/other.dreamrunner.org.access.log;
    error_log /var/log/nginx/other.dreamrunner.org.error.log;
    include global/common.conf;
    include global/wordpress.conf;
    include global/multisite.conf;
}
</pre>
</div>
<ul class="org-ul">
<li><code>server_name</code>: Determine which server block is used for a given URL.
</li>
<li><code>root</code>: The path where your site is stored.
</li>
<li><code>access log &amp; error log</code>: Set the paths for your logs
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5">Restore Wordpress Files</h3>
<div class="outline-text-3" id="text-7-5">
<p>
Copy the Wordpress files to <code>/home/username/www/</code> and upzip;
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo chown www-data:www-data * -R 
sudo usermod -a -G www-data [username]
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">in the wp-config.php file add</span>
<span style="color: #87cefa;">define</span>( <span style="color: #ffa07a;">'FS_METHOD'</span>, <span style="color: #ffa07a;">'direct'</span> )
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">MySQL Tips</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1">list MySQL user</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">

<pre class="src src-sh">SELECT User FROM mysql.user;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2">Create and Delete a MySQL Database</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-sh">SHOW DATABASES;
CREATE DATABASE database name;
DROP DATABASE database name;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3">Access a MySQL Database</h3>
<div class="outline-text-3" id="text-8-3">
<div class="org-src-container">

<pre class="src src-sh">USE events;
SHOW tables;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4">Create a MySQL Table</h3>
<div class="outline-text-3" id="text-8-4">
<div class="org-src-container">

<pre class="src src-sh">CREATE TABLE potluck (id INT NOT NULL PRIMARY KEY AUTO_INCREMENT, 
name VARCHAR(20),
food VARCHAR(30),
confirmed CHAR(1), 
signup_date DATE);
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">the table&#8217;s organization with this command:</span>
DESCRIBE potluck;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5">Add Information to a MySQL Table</h3>
<div class="outline-text-3" id="text-8-5">
<div class="org-src-container">

<pre class="src src-sh">INSERT INTO <span style="color: #fa8072;">`potluck`</span> (<span style="color: #fa8072;">`id`</span>,<span style="color: #fa8072;">`name`</span>,<span style="color: #fa8072;">`food`</span>,<span style="color: #fa8072;">`confirmed`</span>,<span style="color: #fa8072;">`signup_date`</span>) VALUES (NULL, <span style="color: #ffa07a;">"John"</span>, <span style="color: #ffa07a;">"Casserole"</span>,<span style="color: #ffa07a;">"Y"</span>, <span style="color: #ffa07a;">'2012-04-11'</span>);
SELECT * FROM potluck;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6">Update Information in the Table</h3>
<div class="outline-text-3" id="text-8-6">
<div class="org-src-container">

<pre class="src src-sh">UPDATE <span style="color: #fa8072;">`potluck`</span> 
SET 
<span style="color: #fa8072;">`confirmed`</span> = <span style="color: #ffa07a;">'Y'</span> 
WHERE <span style="color: #fa8072;">`potluck`</span>.<span style="color: #fa8072;">`name`</span> =<span style="color: #ffa07a;">'Sandy'</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-7" class="outline-3">
<h3 id="sec-8-7">Add and Delete a Column</h3>
<div class="outline-text-3" id="text-8-7">
<div class="org-src-container">

<pre class="src src-sh">ALTER TABLE potluck ADD email VARCHAR(40);
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">place that column in a specific spot in the table</span>
ALTER TABLE potluck ADD email VARCHAR(40) AFTER name; 
ALTER TABLE potluck DROP email;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-8-8" class="outline-3">
<h3 id="sec-8-8">Delete a Row</h3>
<div class="outline-text-3" id="text-8-8">
<div class="org-src-container">

<pre class="src src-sh">DELETE from [table name] where [row name]=[field text];
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">How To Create a SSL Certificate on nginx for Ubuntu 12.04</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1">Create a Directory for the Certificate</h3>
<div class="outline-text-3" id="text-9-1">
<p>
The SSL certificate has 2 parts main parts: the certificate itself and
the public key.
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo mkdir /etc/nginx/ssl
<span style="color: #b0c4de;">cd</span> /etc/nginx/ssl
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2">Create the Server Key and Certificate Signing Request</h3>
<div class="outline-text-3" id="text-9-2">
<p>
Start by creating the private server key. During this process, you
will be asked to enter a specific passphrase. Be sure to note this
phrase carefully, if you forget it or lose it, you will not be able to
access the certificate.
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo openssl genrsa -des3 -out server.key 1024
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Follow up by creating a certificate signing request:</span>
sudo openssl req -new -key server.key -out server.csr
</pre>
</div>
<p>
This command will prompt terminal to display a lists of fields that need to be filled in.
</p>

<p>
The most important line is "Common Name". Enter your official domain
name here or, if you don't have one yet, your site's IP address. Leave
the challenge password and optional company name blank.
</p>
</div>
</div>
<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3">Remove the Passphrase</h3>
<div class="outline-text-3" id="text-9-3">
<p>
However, it would serve us to remove the passphrase. Although having
the passphrase in place does provide heightened security, the issue
starts when one tries to reload nginx. In the event that nginx
crashes or needs to reboot, you will always have to re-enter your
passphrase to get your entire web server back online.
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo cp server.key server.key.org
sudo openssl rsa -in server.key.org -out server.key
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4">Sign your SSL Certificate</h3>
<div class="outline-text-3" id="text-9-4">
<p>
Keep in mind that you can specify how long the certificate should
remain valid by changing the 365 to the number of days you prefer. As
it stands this certificate will expire after one year.
</p>
<div class="org-src-container">

<pre class="src src-sh">sudo openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5">Set Up the Certificate for Test [option]</h3>
<div class="outline-text-3" id="text-9-5">
<div class="org-src-container">

<pre class="src src-sh">sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/example
sudo nano /etc/nginx/sites-available/example

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">HTTPS server</span>
server {
        listen 443;
        server_name example.com;

        root /usr/share/nginx/www;
        index index.html index.htm;

        ssl on;
        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key; 
}
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-9-6" class="outline-3">
<h3 id="sec-9-6">Activate the Virtual Host</h3>
<div class="outline-text-3" id="text-9-6">
<div class="org-src-container">

<pre class="src src-sh">sudo ln -s /etc/nginx/sites-available/example /etc/nginx/sites-enabled/example
sudo service nginx restart
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">Nginx and PHP5-FPM Configuration and Optimizing Tips</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1">high memory of php5-fpm</h3>
<div class="outline-text-3" id="text-10-1">
<p>
搬移到512Ｍ的digitalocean, Nginx + PHP5-FPM + Wordpress， 发现PHP5-FPM
的memory占用很高。
</p>

<div class="org-src-container">

<pre class="src src-sh">$ ps -A --sort -rss -o comm,pmem,pcpu | uniq -c | head -15
      1 COMMAND         %MEM %CPU
      1 php5-fpm        21.2  0.0
      1 php5-fpm        21.1  0.0
      1 php5-fpm        19.3  0.0
      1 php5-fpm        17.9  0.0
      1 php5-fpm        17.4  0.0
      1 php5-fpm        16.4  0.0
      1 bash             1.5  4.2
      1 php5-fpm         0.6  0.0
      1 rsyslogd         0.6  0.0
      1 nginx            0.5  0.0
      1 init             0.2  0.0
      1 sshd             0.2  0.1
      1 whoopsie         0.2  0.0
      1 nginx            0.2  0.0

$ free
             total       used       free     shared    buffers     cached
Mem:        502740     476344      26396          0       1120      50460
-/+ buffers/cache:     424764      77976
Swap:       524284          0     524284
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2">Nginx</h3>
<div class="outline-text-3" id="text-10-2">
</div><ul class="org-ul"><li><a id="sec-10-2-1" name="sec-10-2-1"></a>Organize Nginx Configuration Files<br  /><div class="outline-text-4" id="text-10-2-1">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">## </span><span style="color: #ff7f24;">Main configuration file ##</span>
/etc/nginx/nginx.conf

<span style="color: #ff7f24;">## </span><span style="color: #ff7f24;">Virtualhost configuration files on ##</span>
/etc/nginx/sites-available/
/etc/nginx/sites-enabled/

<span style="color: #ff7f24;">## </span><span style="color: #ff7f24;">Other config files on (if needed) ##</span>
/etc/nginx/conf.d/
</pre>
</div>
</div>
</li>
<li><a id="sec-10-2-2" name="sec-10-2-2"></a><code>nginx.conf</code><br  /><div class="outline-text-4" id="text-10-2-2">
<div class="org-src-container">

<pre class="src src-sh">worker_processes [number of processor cores];

cat /proc/cpuinfo |grep processor
processor       : 0

worker_processes 1;
</pre>
</div>
</div>
</li>

<li><a id="sec-10-2-3" name="sec-10-2-3"></a>under <code>/etc/nginx/conf.d/</code><br  /><div class="outline-text-4" id="text-10-2-3">
<p>
create <code>user.conf</code>:
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">The charset directive will not only cause Nginx to re-encode </span>
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">anything that is not in the defined character set, </span>
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">it will also add it to the Content-Type HTTP header so browsers know.</span>
charset utf-8;

<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">The default Nginx client_max_body_size is 1mb. </span>
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">That&#8217;s too small for most everything these days</span>
client_max_body_size 32m;
client_body_buffer_size 128k;

<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">Hide Nginx Server Tokens / Hide Nginx version number</span>
server_tokens off;
</pre>
</div>

<p>
create <code>ssl.conf</code>
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">we want to enable ssl session resumption to avoid</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">having to start the handshake from scratch each page load</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">so first we enable a shared cache, named SSL (creative!) that is 10mb large</span>
ssl_session_cache shared:SSL:10m;

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">save things in the cache for 3 minutes</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">if you're not making a request at least every 3 minutes, this isn't going</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">to accomplish anything anyway</span>
ssl_session_timeout 3m;

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">now we're going to change a bunch related to SSL ciphers and protocol</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">the primary goal here is to be more secure, and i've generally tried to</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">go with things that comply with the Federal Information Processing Standard (FIPS)</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">set by the US government for non-military government use</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">we don't want to support SSLv3, it's known to be insecure</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">FIPS 140-2 compliance, TLS1+ only</span>
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">now we go through a couple different options for the SSL ciphers to support, mainly just to</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">give you a bunch of options to pick from</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">this is a very concise definition of ciphers that don't allow anonymous DH or MD5 - the big weaknesses</span>
<span style="color: #ff7f24;">#       </span><span style="color: #ff7f24;">per: https://calomel.org/nginx.html</span>
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">ssl_ciphers HIGH:!ADH!MD5:@STRENGTH;</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">this is a very (not so) short list of very secure ciphers that may be incompatible with older browsers</span>
<span style="color: #ff7f24;">#       </span><span style="color: #ff7f24;">per: https://calomel.org/nginx.html </span>
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:AES128-SHA;</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">this excludes insecure ciphers and sorts the others by strength</span>
<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">it is BEAST-resistant, prioritizing RC4</span>
<span style="color: #ff7f24;">#       </span><span style="color: #ff7f24;">per: http://groups.drupal.org/node/179344</span>
<span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">ssl_ciphers !aNULL:!LOW:!MD5:!EXP:RC4:CAMELLIA:AES128:3DES:SEED:AES256@STRENGTH;</span>

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">this is a combination of everything above and openssl docs - very secure, FIPS-compliant, ordered by strength</span>
ssl_ciphers !aNULL:!eNULL:FIPS@STRENGTH;

<span style="color: #ff7f24;"># </span><span style="color: #ff7f24;">don't let the client decide what ciphers to use, we've told the server which to allow</span>
ssl_prefer_server_ciphers on;
</pre>
</div>
</div>
</li></ul>
</div>
<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3">PHP5-FPM</h3>
<div class="outline-text-3" id="text-10-3">
</div><ul class="org-ul"><li><a id="sec-10-3-1" name="sec-10-3-1"></a>the Configuration Files<br  /><div class="outline-text-4" id="text-10-3-1">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">## </span><span style="color: #ff7f24;">Main configuration file ##</span>
/etc/php5/fpm/php-fpm.conf

<span style="color: #ff7f24;">## </span><span style="color: #ff7f24;">last line of php-fpm.conf:include=/etc/php5/fpm/pool.d/*.conf</span>
<span style="color: #ff7f24;">## </span><span style="color: #ff7f24;">Other config files on (if needed) ##</span>
/etc/php5/fpm/pool.d/
</pre>
</div>
</div>
</li>
<li><a id="sec-10-3-2" name="sec-10-3-2"></a><code>pool.d/www.conf</code><br  /><div class="outline-text-4" id="text-10-3-2">
<div class="org-src-container">

<pre class="src src-sh">pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3
<span style="color: #eedd82;">listen</span> = /var/run/php5-fpm.socket
</pre>
</div>
</div>
</li></ul>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
<a href="https://www.digitalocean.com/community/articles/initial-server-setup-with-ubuntu-12-04">https://www.digitalocean.com/community/articles/initial-server-setup-with-ubuntu-12-04</a>
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
<a href="https://www.digitalocean.com/community/articles/how-to-protect-ssh-with-fail2ban-on-ubuntu-12-04">https://www.digitalocean.com/community/articles/how-to-protect-ssh-with-fail2ban-on-ubuntu-12-04</a>
</p></div>

<div class="footdef"><sup><a id="fn.3" name="fn.3" class="footnum" href="#fnr.3">3</a></sup> <p class="footpara">
<a href="https://www.digitalocean.com/community/articles/how-to-install-denyhosts-on-ubuntu-12-04">https://www.digitalocean.com/community/articles/how-to-install-denyhosts-on-ubuntu-12-04</a>
</p></div>

<div class="footdef"><sup><a id="fn.4" name="fn.4" class="footnum" href="#fnr.4">4</a></sup> <p class="footpara">
<a href="https://www.digitalocean.com/community/articles/how-to-add-swap-on-ubuntu-12-04">https://www.digitalocean.com/community/articles/how-to-add-swap-on-ubuntu-12-04</a>
</p></div>

<div class="footdef"><sup><a id="fn.5" name="fn.5" class="footnum" href="#fnr.5">5</a></sup> <p class="footpara">
<a href="https://www.digitalocean.com/community/articles/how-to-install-linux-nginx-mysql-php-lemp-stack-on-ubuntu-12-04">https://www.digitalocean.com/community/articles/how-to-install-linux-nginx-mysql-php-lemp-stack-on-ubuntu-12-04</a>
</p></div>

<div class="footdef"><sup><a id="fn.6" name="fn.6" class="footnum" href="#fnr.6">6</a></sup> <p class="footpara">
<a href="https://www.digitalocean.com/community/articles/how-to-configure-single-and-multiple-wordpress-site-settings-with-nginx">https://www.digitalocean.com/community/articles/how-to-configure-single-and-multiple-wordpress-site-settings-with-nginx</a>
</p></div>

<div class="footdef"><sup><a id="fn.7" name="fn.7" class="footnum" href="#fnr.7">7</a></sup> <p class="footpara">
<a href="https://www.digitalocean.com/community/articles/how-to-migrate-wordpress-from-shared-hosting-to-a-cloud-server-with-zero-downtime">https://www.digitalocean.com/community/articles/how-to-migrate-wordpress-from-shared-hosting-to-a-cloud-server-with-zero-downtime</a>
</p></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Shi Shougang</p>
<p class="date">Created: 2015-03-05 Thu 23:19</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
